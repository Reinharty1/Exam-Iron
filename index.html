<script>
  let questions = [];
  let studentName = "";

  async function startExam() {
    const nameInput = document.getElementById("studentName").value.trim();
    if (!nameInput) {
      alert("Please enter your name before starting.");
      return;
    }

    studentName = nameInput;
    document.getElementById("nameSection").style.display = "none";
    document.getElementById("quizContainer").style.display = "block";
    document.getElementById("submitBtn").style.display = "inline-block";

    await loadQuestions();
  }

  async function loadQuestions() {
    const response = await fetch('exam_full_100.json');
    questions = await response.json();

    // Randomly pick 20 questions
    questions = questions.sort(() => 0.5 - Math.random()).slice(0, 20);
    displayQuestions();
  }

  function displayQuestions() {
    const container = document.getElementById("quizContainer");
    container.innerHTML = "";
    questions.forEach((q, i) => {
      const optionsHTML = q.options.map((opt, j) => `
        <label>
          <input type="radio" name="q${i}" value="${j}"> ${opt}
        </label><br>
      `).join("");

      container.innerHTML += `
        <div class="question">
          <p><strong>Q${i + 1}:</strong> ${q.question}</p>
          ${optionsHTML}
        </div>
      `;
    });
  }

  function submitExam() {
    let score = 0;
    const container = document.getElementById("quizContainer");
    const questionsDivs = container.getElementsByClassName("question");

    questions.forEach((q, i) => {
      const selected = document.querySelector(`input[name="q${i}"]:checked`);
      const selectedValue = selected ? parseInt(selected.value) : null;
      const selectedText = selected ? q.options[selectedValue] : null;

      let feedback = "";

      if (selectedText === q.answer) {
        score++;
        feedback = `<p class="correct">‚úÖ Correct!</p>`;
      } else {
        feedback = `<p class="wrong">‚ùå Wrong! Correct answer: <strong>${q.answer}</strong></p>`;
      }

      questionsDivs[i].insertAdjacentHTML('beforeend', feedback);
    });

    document.getElementById("submitBtn").style.display = "none";
    showResult(score, questions.length);
  }

  function showResult(score, total) {
    const result = document.getElementById("resultBox");
    result.innerHTML = `
      <h2>Exam Completed!</h2>
      <p><strong>${studentName}</strong>, your final score is:</p>
      <h3 style="color:green">${score} / ${total}</h3>
      <p>Saving your score...</p>
    `;

    // Save result to server
    fetch('/save-result', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: studentName, score, total })
    })
    .then(() => {
      result.innerHTML += `
        <p style="color:gray">‚úÖ Score saved successfully!</p>
        <p><a href="/leaderboard" target="_blank">üèÜ View Leaderboard</a></p>`;
    })
    .catch(() => {
      result.innerHTML += `<p style="color:red">‚ö†Ô∏è Could not save score (offline mode).</p>`;
    });

    window.scrollTo(0, document.body.scrollHeight);
  }
</script>
